# 用户配置文件同步策略文档

这个文档记录了用户配置文件同步的离线优先策略和通知机制的核心改进。

## 🔄 离线优先策略的核心原理

### 时间间隔配置

- **同步间隔**: 5分钟
- **最大缓存时间**: 30分钟  
- **API 请求冷却期**: 5分钟

### 策略分层

- **新鲜缓存（5分钟内）**: 直接返回
- **过期但可用（30分钟内）**: 返回缓存，后台同步
- **缓存太旧（30分钟外）**: 尝试同步，失败时返回过期缓存
- **无缓存**: 强制同步获取

### 防重复请求机制

- **冷却期**: 5分钟 API 请求冷却期
- **时间戳存储**: Chrome Storage 存储时间戳
- **强制绕过**: 强制刷新可绕过冷却期
- **目的**: 防止 React Query 触发的循环请求

## 🎯 同步状态机制

- **PENDING**: 等待同步
- **SYNCING**: 正在同步中
- **SYNCED**: 同步完成
- **FAILED**: 同步失败

## ✨ 关键改进点

### 1. 离线容错能力

- **描述**: 即使网络失败，也能返回可用的缓存数据
- **实现**: 多层缓存策略，失败时降级处理

### 2. 后台同步机制

- **描述**: 用户操作不会被同步阻塞，提供即时响应
- **实现**: 异步后台同步 + 实时状态通知

### 3. 实时状态通知

- **描述**: 所有 UI 组件都能实时感知配置文件变化
- **实现**: 通过 content script 消息广播状态更新

### 4. 智能缓存策略

- **描述**: 根据数据新鲜度自动选择最优的获取策略
- **实现**: 分层缓存时间 + 失败降级机制

### 5. 防循环请求保护

- **描述**: 防止 React Query 触发的重复 API 请求循环
- **实现**: 时间戳冷却期 + 强制绕过机制

## 🚀 用户体验优化

- **快速响应**: 界面响应速度快，无等待感
- **离线可用**: 离线状态下仍可正常使用
- **自动恢复**: 网络恢复后自动同步最新数据
- **状态透明**: 同步状态对用户透明可见

## 🏗️ 核心函数架构说明

### getUserProfile

- **目的**: 获取用户配置文件的主要入口
- **策略**: 离线优先，智能缓存
- **流程**:
  1. 检查缓存新鲜度
  2. 根据新鲜度选择策略
  3. 后台同步（如需要）
  4. 返回可用数据

### fetchAndCacheUserProfile

- **目的**: 从云端获取并缓存用户配置
- **策略**: 容错处理，失败降级
- **流程**:
  1. 获取认证状态
  2. 调用云端API
  3. 缓存到本地
  4. 失败时返回缓存

### syncUserProfileInBackground

- **目的**: 后台异步同步用户配置
- **策略**: 状态透明，错误处理
- **流程**:
  1. 标记同步中状态
  2. 通知UI同步开始
  3. 执行同步操作
  4. 通知UI同步结果

### notifyContentScriptProfileUpdate

- **目的**: 向所有页面通知配置更新
- **策略**: 并发通知，容错处理
- **流程**:
  1. 获取所有标签页
  2. 并发发送通知
  3. 统计通知结果
  4. 记录执行状态

## ❌ 错误处理策略

- **网络失败**: 网络失败时返回缓存数据
- **API 错误**: API错误时保持本地状态
- **缓存缺失**: 缓存缺失时强制同步
- **通知失败**: 通知失败不影响核心功能
- **循环预防**: API 请求冷却期防止无限循环

## 🔄 防循环请求机制详解

### 问题描述

React Query 触发的循环请求问题：

1. Background 通知 Content Script 配置更新
2. Content Script 中的 React Query 重新请求
3. 新请求触发 Background API 调用
4. API 响应后再次通知更新
5. 形成无限循环

### 解决方案

基于时间戳的冷却期机制：

1. Chrome Storage 存储 API 请求时间戳
2. 每次 API 请求前检查冷却期（5分钟）
3. 冷却期内跳过 API 请求，返回缓存数据
4. 强制刷新可绕过冷却期限制
5. 登录/注册等关键操作自动强制刷新

### Storage 键名

- **时间戳**: `craz-last-api-request-timestamp`
- **目的**: 记录最后一次成功 API 请求的时间

### 绕过条件

- 强制刷新 (forceRefresh = true)
- 用户登录后的配置获取
- 用户注册后的配置获取
- 用户手动同步操作

## 🔧 性能优化措施

- **并发通知**: 并发发送通知消息
- **异步后台同步**: 异步后台同步不阻塞用户操作
- **智能轮询**: 智能轮询避免不必要的API调用
- **优雅降级**: 优雅降级确保基本功能可用
